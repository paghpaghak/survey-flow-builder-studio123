# Условная логика видимости

## Обзор

Survey Builder Platform поддерживает мощную систему условной логики, которая позволяет динамически показывать или скрывать вопросы и страницы в зависимости от ответов пользователя.

## Основные концепции

### Типы условий

#### Для ответов
- `answered` - Проверяет, что пользователь дал ответ на вопрос
- `not_answered` - Проверяет, что ответ не был дан
- `answer_equals` - Ответ равен определенному значению
- `answer_not_equals` - Ответ не равен определенному значению
- `answer_contains` - Ответ содержит определенную строку (для текстовых полей)
- `answer_greater_than` - Ответ больше числового значения
- `answer_less_than` - Ответ меньше числового значения
- `answer_includes` - Ответ включает определенное значение (для множественного выбора)

### Логические операторы

#### Внутри группы условий
- `AND` - Все условия в группе должны быть выполнены
- `OR` - Хотя бы одно условие в группе должно быть выполнено

#### Между группами
- `AND` - Все группы должны пройти проверку
- `OR` - Хотя бы одна группа должна пройти проверку

### Действия
- `show` - Показать элемент, если условие выполнено
- `hide` - Скрыть элемент, если условие выполнено

## Архитектура

### Типы данных

```typescript
// Базовое условие
type VisibilityCondition = 
  | { type: 'answered'; questionId: string }
  | { type: 'answer_equals'; questionId: string; value: string | number | boolean }
  // ... другие типы

// Группа условий
interface VisibilityGroup {
  id: string;
  logic: 'AND' | 'OR';
  conditions: VisibilityCondition[];
}

// Правило видимости
interface QuestionVisibilityRule {
  id: string;
  action: 'show' | 'hide';
  groups: VisibilityGroup[];
  groupsLogic: 'AND' | 'OR';
}
```

### Централизованный движок

`ConditionalLogicEngine` - основной класс для обработки условной логики:

```typescript
// Проверка видимости отдельного вопроса
ConditionalLogicEngine.isQuestionVisible(question, answers, allQuestions)

// Получение всех видимых вопросов
ConditionalLogicEngine.getVisibleQuestions(questions, answers, allQuestions)

// Проверка видимости страницы
ConditionalLogicEngine.isPageVisible(page, answers, allQuestions)
```

## Использование в UI

### Настройка в редакторе вопросов

В диалоге редактирования вопроса во вкладке "Логика" есть две секции:

1. **Переходы между вопросами** - настройка логики переходов (существующая функциональность)
2. **Условия видимости** - новая секция для настройки условной видимости

### Структура UI условий видимости

```
Правило 1: [Показать/Скрыть] вопрос
├── Группа 1 [И/ИЛИ]
│   ├── Вопрос [Тип условия] [Значение]
│   └── Вопрос [Тип условия] [Значение]
├── Группа 2 [И/ИЛИ]
│   └── Вопрос [Тип условия] [Значение]
└── Логика между группами: [И/ИЛИ]
```

## Примеры использования

### Простое условие

**Задача**: Показать вопрос "Стаж вождения?" только если пользователь ответил "Да" на вопрос "Есть ли права?"

```typescript
const visibilityRule: QuestionVisibilityRule = {
  id: 'rule1',
  action: 'show',
  groups: [{
    id: 'group1',
    logic: 'AND',
    conditions: [{
      type: 'answer_equals',
      questionId: 'driving_license',
      value: 'yes'
    }]
  }],
  groupsLogic: 'AND'
};
```

### Сложное условие с OR логикой

**Задача**: Показать вопрос "Почему нет прав?" если:
- Пользователь ответил "Нет" на вопрос о правах ИЛИ
- Возраст больше 65 лет

```typescript
const visibilityRule: QuestionVisibilityRule = {
  id: 'rule2',
  action: 'show',
  groups: [{
    id: 'group1',
    logic: 'OR',
    conditions: [
      {
        type: 'answer_equals',
        questionId: 'driving_license',
        value: 'no'
      },
      {
        type: 'answer_greater_than',
        questionId: 'age',
        value: 65
      }
    ]
  }],
  groupsLogic: 'AND'
};
```

### Множественные группы с AND логикой

**Задача**: Показать вопрос только если:
- (Возраст = 25 И есть ответ на вопрос о правах) И
- (Права = "Да" ИЛИ Права = "Возможно")

```typescript
const visibilityRule: QuestionVisibilityRule = {
  id: 'rule3',
  action: 'show',
  groups: [
    {
      id: 'group1',
      logic: 'AND',
      conditions: [
        { type: 'answer_equals', questionId: 'age', value: 25 },
        { type: 'answered', questionId: 'driving_license' }
      ]
    },
    {
      id: 'group2',
      logic: 'OR',
      conditions: [
        { type: 'answer_equals', questionId: 'driving_license', value: 'yes' },
        { type: 'answer_equals', questionId: 'driving_license', value: 'maybe' }
      ]
    }
  ],
  groupsLogic: 'AND' // Обе группы должны быть выполнены
};
```

## Интеграция в компоненты

### Предпросмотр (PagePreview)

```typescript
// Фильтрация видимых вопросов
const visibleQuestions = ConditionalLogicEngine.getVisibleQuestions(
  pageQuestions,
  answers,
  allQuestions
);

// Рендеринг только видимых вопросов
{visibleQuestions.map(question => (
  <QuestionComponent key={question.id} question={question} />
))}
```

### Прохождение опроса (SurveyPage)

```typescript
// Аналогичная фильтрация для реального прохождения
const visibleQuestions = ConditionalLogicEngine.getVisibleQuestions(
  page.questions || [],
  answers,
  allQuestions
);
```

## Логика по умолчанию

### Правила показа (show)
- Если у вопроса есть правила показа, он **скрыт по умолчанию**
- Показывается только если хотя бы одно правило выполнено

### Правила скрытия (hide)
- Если у вопроса есть только правила скрытия, он **видим по умолчанию**
- Скрывается только если хотя бы одно правило выполнено

### Без правил
- Вопросы без правил видимости **всегда видимы**

## Производительность

### Оптимизации
- Условия проверяются только при изменении ответов
- Кэширование результатов в компонентах React
- Ленивая оценка условий (короткое замыкание)

### Рекомендации
- Избегайте сложных цепочек зависимостей
- Используйте простые условия где возможно
- Тестируйте производительность на больших опросах

## Будущие улучшения

### Планируемые функции
- Проверка циклических зависимостей
- Визуальные индикаторы в SidebarTreeView (опционально)
- Условная логика между страницами
- Импорт/экспорт правил
- Предварительный просмотр логики

### API расширения
- Пользовательские типы условий
- Плагины для специфичной логики
- Интеграция с внешними системами

## Тестирование

Система включает комплексные тесты:
- Unit-тесты для `ConditionalLogicEngine`
- Тесты различных типов условий
- Тесты сложной логики с группами
- E2E тесты пользовательских сценариев

```bash
# Запуск тестов условной логики
npx vitest run tests/unit/conditional-logic.test.ts
```

## Устранение неполадок

### Частые проблемы

1. **Вопрос не показывается**
   - Проверьте, что все условия в правиле show выполнены
   - Убедитесь, что нет конфликтующих правил hide

2. **Вопрос не скрывается**
   - Проверьте логику группы (AND vs OR)
   - Убедитесь, что questionId корректен

3. **Условие не работает**
   - Проверьте тип данных значения (строка vs число)
   - Убедитесь, что вопрос-источник существует

### Отладка

```typescript
// Логирование в консоли браузера
console.log('[ConditionalLogic] Answers:', answers);
console.log('[ConditionalLogic] Visible questions:', visibleQuestions);
```

## Архитектура определения порядка вопросов

### Новая система (после рефакторинга)

С версии, включающей условную логику, была пересмотрена архитектура определения порядка прохождения вопросов для устранения конфликтов между различными компонентами.

#### Принципы определения порядка:

1. **Позиция в визуальном редакторе** (`position.y`) - основной критерий
   - Вопросы сортируются по Y-координате на визуальном холсте
   - Новые вопросы автоматически размещаются под последним

2. **Transition Rules** - кастомные правила переходов
   - Позволяют создавать нелинейные сценарии прохождения
   - Переопределяют стандартный порядок для конкретных ответов

3. **Условная логика** - правила видимости
   - Фильтрует видимые вопросы на основе предыдущих ответов
   - Применяется поверх основного порядка

#### Роль компонентов:

- **Sidebar** - только навигационный интерфейс
  - Drag-and-drop сохранен для удобства организации
  - НЕ влияет на реальный порядок прохождения
  - Показывает иерархию: страницы → вопросы → параллельные группы

- **Визуальный редактор** - основной инструмент определения порядка
  - Позиция узлов определяет последовательность
  - Стрелки показывают связи и переходы

- **Preview/Taking компоненты** - используют новую логику
  - `getQuestionsRealOrder()` для получения правильного порядка
  - `hasCustomTransitionRules()` для выбора режима отображения

#### Преимущества новой архитектуры:

1. **Устранение конфликтов** между порядком в sidebar и визуальным редактором
2. **Четкое разделение ответственности** компонентов
3. **Интуитивность** - порядок определяется визуально
4. **Консистентность** между предпросмотром и реальным прохождением
5. **Гибкость** настройки сложных сценариев через transition rules

#### Утилиты для работы с порядком:

```typescript
// Получение реального порядка вопросов на странице
const pageQuestions = getQuestionsRealOrder(questions, pageId);

// Проверка наличия кастомных правил переходов
const hasCustomRules = hasCustomTransitionRules(questions);

// Поиск стартового вопроса для последовательности
const startQuestion = findStartQuestion(questions);
```

#### Миграция с предыдущей версии:

При обновлении с предыдущих версий порядок вопросов будет определяться по их Y-позиции в визуальном редакторе. Если позиции не заданы, вопросы будут отображаться в порядке создания с автоматическим позиционированием.

---

*Документация актуальна для версии Survey Builder Platform v1.0+* 